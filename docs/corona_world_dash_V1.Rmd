---
title: "Covid-19"
output: 
  flexdashboard::flex_dashboard:
    css: style.css
    orientation: rows
    vertical_layout: scroll
  rmarkdown:: github_document
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(sidrar)



# Some color schemes: 

# hex msafra: #4c1211
# rgb msafra: 761817
plotlyColors <-   c('#740001',
                    '#005b96',
                    '#23272a',
                    '#d3a625',
                    '#008744',
                    '#fb2e01',
                    '#01cdfe',
                    '#99aab5',
                    '#ffc425',
                    '#00b159',
                    '#d11141',
                    '#00aedb',
                    '#777777',
                    '#ffe28a',
                    '#6fcb9f',
                    '#0057e7',
                    '#ae0001',
                    '#05ffa1',
                    '#b967ff',
                    '#7289da',
                    '#f37735',
                    '#666547',
                    '#d62d20',
                    '#6497b1',
                    '#b3cde0',
                    '#ff4d00',
                    '#66545e',
                    '#a39193',
                    '#aa6f73',
                    '#eea990'
                    )




 
# Setting time span: Watch out the time of updating
dias <- ceiling(difftime(Sys.Date(), "2020-01-22", units = "days")) #-1

# Choose here the path to output png plots:
ggpath  <- "C:/Users/Padulla/Documents/GitHub/corona_dash/"
Here    <- Sys.Date()
HereUSA <- Here - 1
HereBR  <- Here - 0

# loading stuff
source("Functions.R")
source("World.R")
source("USA.R")
source("Brazil.R")

# Reading country codes for map plot. 
WorldCodes <- read_csv(file = "../worldCodes.csv"
                      ,col_names = TRUE
                      ,col_types = 'cc')

USACodes <-read_csv(file = "../usaCodes.csv"
                   ,col_names = TRUE
                   ,col_types = 'cc')
```

Overview {data-navmenu='World'}
======================================================================

Row {data-width = 800, data-height = 100}
-----------------------------------------

### World Cases {.no-title}
```{r, fig.width = 10, fig.height = 7}
# MAGIC TIME! Joinining dataframes by country and filling the NA with 0
dg <- WorldCases %>% 
        tibble::rownames_to_column() %>% 
        select(1, last_col()) %>% 
        rename_all(~ c("COUNTRY", "CASES")) %>% 
        left_join(WorldCodes, ., by = 'COUNTRY') %>% 
        mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) 

plotMap(dg, 'world', "Worldwide COVID-19 Cases")
```

Row {data-width=350, data-height=350}
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Total Cases </b>
```{r}
tableWorldCases
```

### <b style = "color: #4c1112" > Total Deaths </b>
```{r}
tableWorldDeaths
```

Mortality {data-navmenu='World'}
==========================================================================

Column {.tabset}
-----------------------------------------------------------------------

### <b style = "color: #4c1112"> Mortality Rate </b>
```{r, fig.height = 6, fig.width = 10}
WorldCountries <- c("United States"
                   ,"Italy"
                   ,"Spain"
                   ,"France"
                   ,"United Kingdom"
                   #,"Iran"
                   ,"China"
                   ,"Germany"
                   ,"Netherlands"
                   ,"Brazil")

plotMortality(WorldMortality, WorldCountries, "Mortality Rate by Country")
```

### <b style = "color: #4c1112">  Daily variation of Mortality </b>
```{r, fig.height = 6, fig.width = 10}
dx <- 
WorldMortality %>% 
  mutate_at(vars(-Dates), ~ . - lag(.)) %>% 
  mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) %>% 
  mutate_at(vars(-Dates), ~ round(., 2))

plotMortality(WorldMortality, WorldCountries, "Mortality Variation")
```

Cases {data-navmenu='Europe'} 
==========================================================================

Column 
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Comparative after 100 cases </b>
```{r, fig.width = 10, fig.height = 6}
countries <- c("Italy", "Spain", "France", "Germany", "United Kingdom", "Netherlands")
plots <- plotThis(WorldCases, countries, ytitle = "Confirmed Cases", xtitle = "Days from 100 Cases")
plots$plotly
ggsave(paste0(ggpath, "1EuropeCases.png"))
```

### <b style = "color: #4c1112" > Europe: Total Cases </b>
```{r, fig.width = 10, fig.height = 6, fig.align = 'right'}
## MAGIC TIME! Joinining dataframes by country and filling the NA with 0
dg <- WorldCases %>% 
        tibble::rownames_to_column() %>% 
        select(1, last_col()) %>% 
        rename_all(~ c("COUNTRY", "CASES")) %>% 
        left_join(WorldCodes, ., by = 'COUNTRY') %>% 
        mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) 

plotMap(dg, 'europe', "Europe COVID-19 Cases")
```

Column {data-width=350}
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Total Cases </b>
```{r}
printDT(WorldCases, 
        SelectedCountries
       )
```


### <b style = "color: #4c1112" > New Cases </b>
```{r}
printDT(dife_c, 
        SelectedCountries
       ) 
```

### <b style = "color: #4c1112" > Var (%) </b>
```{r}
printDT(porce_c / 100, 
        SelectedCountries
      ) %>% DT::formatPercentage(1:5, 2)
```

Deaths {data-navmenu='Europe'} 
==========================================================================

Column 
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Comparative After 100 deaths </b>
```{r, fig.width = 10, fig.height = 6}
countries <- c("Italy", "Spain", "France", "Germany", "United Kingdom", "Netherlands")
plots <- plotThis(WorldDeaths, countries, ytitle = "Confirmed Deaths", xtitle = "Days from 100 Deaths")
plots$plotly
ggsave(paste0(ggpath, "2EuropeDeaths.png"))
```

### <b style = "color: #4c1112">  Europe: total deaths </b>
```{r, fig.width = 10, fig.height = 6, fig.align = 'right'}
## MAGIC TIME! Joinining dataframes by country and filling the NA with 0
dg <- WorldDeaths %>% 
        tibble::rownames_to_column() %>% 
        select(1, last_col()) %>% 
        rename_all(~ c("COUNTRY", "CASES")) %>% 
        left_join(WorldCodes, ., by = 'COUNTRY') %>% 
        mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) 

plotMap(dg, 'europe', "Europe COVID-19 Deaths")
```

Column {data-width=350}
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Total Deaths </b>
```{r}
printDT(WorldDeaths,
        SelectedCountries
       )
```


### <b style = "color: #4c1112" > New Deaths </b>
```{r}
printDT(dife_d, 
        SelectedCountries
       )
```


### <b style = "color: #4c1112" > Var (%) </b>
```{r}
printDT(porce_d / 100, 
        SelectedCountries
       ) %>% DT::formatPercentage(1:5, 2)
```

Mortality {data-navmenu='Europe'}
=========================================================================

Column {.tabset}
-----------------------------------------------------------------------

### <b style = "color: #4c1112"> Mortality Rate </b>
```{r, fig.height = 6, fig.width = 10}
plotMortality(WorldMortality, countries, "Europe Mortality Rate")
```

### <b style = "color: #4c1112">  Daily variation of Mortality </b>
```{r, fig.height = 6, fig.width = 10}
plotMortality(dx, countries, "Europe Mortality Variation")
```

Cases {data-navmenu='US'} 
==========================================================================

Column 
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Comparative After 100 cases </b>
```{r, fig.width = 10, fig.height = 6}
states <- c("New York", "New Jersey", "Michigan", "California", "Massachussets", "Florida", "Washington", "Texas")
abr    <- c("NY", "NJ", "MI", "CA", "MA", "FL", "WA", "TX")
 
plot <- plotThis(UsCases, states, abr, ytitle = "Confirmed Cases", xtitle = "Days from 100 Cases")
plot$plotly
ggsave(paste0(ggpath, "3USACases.png"))
```

### <b style = "color: #4c1112">  USA: total cases </b>
```{r, fig.width = 10, fig.height = 6, fig.align = 'right'}
## MAGIC TIME! Joinining dataframes by country and filling the NA with 0
dg <- UsCases %>% 
        tibble::rownames_to_column() %>% 
        select(1, last_col()) %>% 
        rename_all(~ c("code", "CASES")) %>% 
        left_join(USACodes, ., by = 'code') %>% 
        mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) %>% 
        rename_at(vars(code, state), ~ c("CODE", "COUNTRY"))

plotMap(dg, 'usa', "USA COVID-19 Cases", proj = "albers usa")
```

Column {data-width=350}
-----------------------------------------------------------------------

### <b style = "color: #4c1112">  Total Cases </b>
```{r}
printDT(UsCasesFormatted, 
        rownames(UsCasesFormatted)
        )
```


### <b style = "color: #4c1112"> New Cases </b>
```{r}
printDT(dife_c_us,
        rownames(dife_c_us)
        )
```

### <b style = "color: #4c1112"> Var. (%) </b>
```{r}
printDT(porce_c_us / 100,
        rownames(porce_c_us)
        ) %>% DT::formatPercentage(1:5, 2)
```


Cases per day Graphs {data-navmenu='US'} 
==========================================================================

Column
-----------------------------------------------------------------------

### Cases per day
```{r, fig.width = 10, fig.height = 15}
cols_names <- USACodes %>% rbind("US") 
dz <- 
  UsCases[-c(57), ]  %>%
  mutate(States = cols_names$state) %>%
  select(States, everything())
  rownames(dz) <- dz[,1]
  dz[,1] <- NULL

  dz <- t(dz) %>% 
  as_tibble %>% 
  mutate_all(~ . - lag(.)) %>% 
  mutate(Dates = as.Date(colnames(UsCases), format = "%m/%d/%y") ) %>% 
  select(Dates, everything()) %>% 
  mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .))



dw <- 
do.call(cbind, lapply(colnames(dz)[-1], function(x) TTR::SMA(dz[,x], 7))) %>% 
  as_tibble %>% 
  rename_all(~ paste0('M',colnames(dz)[-1])) %>% 
  mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) 

dh <- 
cbind(dz, dw) %>% 
  as_tibble %>%   
  filter(Dates >= as.Date("2020-03-20"))

f2 <- list(family = 'Old Standard TT, serif', size = 14, color = I("firebrick4"))

plots <- 
lapply(colnames(dh)[2:58], function(x){ 
                           expr   <- paste0("~", "`", x, "`")
                           mexpr  <- paste0("~", "`", "M", x, "`")
                           legm   <- paste0("Moving average of ", x)
                           a <- list(
                                      text = x,
                                      font = f2,
                                      xref = "paper",
                                      yref = "paper",
                                      yanchor = "bottom",
                                      xanchor = "center",
                                      align = "center",
                                      x = 0.5,
                                      y = 1,
                                      showarrow = FALSE
                                    )
                           plot_ly(dh, x = ~Dates) %>% 
                             add_trace(y = as.formula(expr),  type = 'bar', color = I("firebrick4")) %>% 
                             add_trace(y = as.formula(mexpr), type = 'scatter', mode = 'lines', color = I("black") ) %>% 
                             layout(showlegend = FALSE, annotations = a)
})
names(plots) <- colnames(dz)[-c(1, length(dz))]
p <- subplot(plots, nrows = 10, shareX = FALSE, shareY = FALSE)
p
```




Deaths {data-navmenu='US'} 
==========================================================================

Column 
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Comparative After 100 cases </b>
```{r, fig.width = 10, fig.height = 6}
states <- c("New York", "New Jersey", "Michigan", "California", "Massachussets", "Florida", "Washington", "Texas")
abr    <- c("NY", "NJ", "MI", "CA", "MA", "FL", "WA", "TX")

plot <- plotThis(UsCases, states, abr, ytitle = "Confirmed Cases", xtitle = "Days from 100 Cases")
plot$plotly
ggsave(paste0(ggpath, "4USADeaths.png"))
```

### <b style = "color: #4c1112">  USA: total deaths </b>
```{r, fig.width = 10, fig.height = 6, fig.align = 'right'}
## MAGIC TIME! Joinining dataframes by country and filling the NA with 0
dg <- UsDeaths %>% 
        tibble::rownames_to_column() %>% 
        select(1, last_col()) %>% 
        rename_all(~ c("code", "CASES")) %>% 
        left_join(USACodes, ., by = 'code') %>% 
        mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .))  %>% 
        rename_at(vars(code, state), ~ c("CODE", "COUNTRY"))

plotMap(dg, 'usa', "USA COVID-19 Deaths", proj = 'albers usa')
```


Column {data-width=350}
-----------------------------------------------------------------------

### <b style = "color: #4c1112">  Total Deaths </b>
```{r}
printDT(UsDeathsFormatted, 
        rownames(UsDeathsFormatted)
        )
```


### <b style = "color: #4c1112"> New Deaths </b>
```{r}
printDT(dife_d_us,
        rownames(dife_d_us)
        )
```

### <b style = "color: #4c1112"> Var. (%) </b>
```{r}
printDT(porce_d_us / 100,
        rownames(porce_d_us)
        ) %>% DT::formatPercentage(1:5, 2)
```


Deaths per day Graphs {data-navmenu='US'} 
==========================================================================

Column
-----------------------------------------------------------------------

### Deaths per day
```{r, fig.width = 10, fig.height = 15}
cols_names <- USACodes %>% rbind("US") 
dz <- 
  UsDeaths[-c(57), ]  %>%
  mutate(States = cols_names$state) %>%
  select(States, everything())
  rownames(dz) <- dz[,1]
  dz[,1] <- NULL

  dz <- t(dz) %>% 
  as_tibble %>% 
  mutate_all(~ . - lag(.)) %>% 
  mutate(Dates = as.Date(colnames(UsDeaths), format = "%m/%d/%y") ) %>% 
  select(Dates, everything()) %>% 
  mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .))



dw <- 
do.call(cbind, lapply(colnames(dz)[-1], function(x) TTR::SMA(dz[,x], 7))) %>% 
  as_tibble %>% 
  rename_all(~ paste0('M',colnames(dz)[-1])) %>% 
  mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) 

dh <- 
cbind(dz, dw) %>% 
  as_tibble %>%   
  filter(Dates >= as.Date("2020-03-20"))

f2 <- list(family = 'Old Standard TT, serif', size = 14, color = I("firebrick4"))

plots <- 
lapply(colnames(dh)[2:58], function(x){ 
                           expr   <- paste0("~", "`", x, "`")
                           mexpr  <- paste0("~", "`", "M", x, "`")
                           legm   <- paste0("Moving average of ", x)
                           a <- list(
                                      text = x,
                                      font = f2,
                                      xref = "paper",
                                      yref = "paper",
                                      yanchor = "bottom",
                                      xanchor = "center",
                                      align = "center",
                                      x = 0.5,
                                      y = 1,
                                      showarrow = FALSE
                                    )
                           plot_ly(dh, x = ~Dates) %>% 
                             add_trace(y = as.formula(expr),  type = 'bar', color = I("firebrick4")) %>% 
                             add_trace(y = as.formula(mexpr), type = 'scatter', mode = 'lines', color = I("black") ) %>% 
                             layout(showlegend = FALSE, annotations = a)
})
names(plots) <- colnames(dz)[-c(1, length(dz))]
p <- subplot(plots, nrows = 10, shareX = FALSE, shareY = FALSE)
p
```




Mortality {data-navmenu="US"}
==========================================================================

Column {.tabset}
-----------------------------------------------------------------------

### <b style = "color: #4c1112"> Mortality Rate </b>
```{r, fig.height = 6, fig.width = 10}
UsMortalityFormatted <-      
UsMortality %>% 
  select(Dates, abr) %>% 
  mutate_at(vars(-Dates), ~ round(., 2)) %>% 
  rename_at(vars(-Dates), ~ states) %>% 
  filter(Dates >= as.Date("2020-03-05"))

plotMortality(UsMortalityFormatted, states, "USA Mortality Rate by State")
```

### <b style = "color: #4c1112">  Daily variation of Mortality </b>
```{r, fig.height = 6, fig.width = 10}
dx <- 
UsMortalityFormatted %>% 
  mutate_at(vars(-Dates), ~ . - lag(.)) %>% 
  mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) %>% 
  mutate_at(vars(-Dates), ~ round(., 2))

plotMortality(dx, states, "USA Mortality Rate Variation by State")
```

Cases {data-navmenu='Brasil'} 
==========================================================================

Column {.tabset}
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Comparative after 100 cases </b>
```{r, fig.width = 10, fig.height = 6}
states <- c("SP"
           ,"RJ"
           ,"CE"
           ,"MG"
           ,"RS"
           ,"DF"
           ,"PR"
           ,"BA"
           ,"AM"
           ,"SC"
           ,"RN"
           ,"PE"
           ,"ES"
           ,"MA"
           ,"GO"
           ,"PA"
           ,"MS"
           ,"MT"
           ,"AC"
           ,"SE"
           ,"AL"
           ,"TO"
           ,"RO"
           ,"AP"
           ,"PB"
           ,"PI"
           ,"RR"
           )

S_SE <- c("SP"
           ,"RJ"
           ,"MG"
           ,"RS"
           ,"PR"
           ,"SC"
           ,"ES"
           )


Norte <- c("AM"
           ,"PA"
           ,"AC"
           ,"TO"
           ,"RO"
           ,"AP"
           ,"RR"
           )


CO <- c("DF"
        ,"GO"
           ,"MS"
           ,"MT"
           )

NE <- c("CE"
         ,"BA"
           ,"PE"
           ,"MA"
           ,"SE"
           ,"AL"
           ,"PB"
           ,"PI"
           ,"RR"
           )


plotN <- plotThis(BrCases, Norte, ytitle = "Confirmed Cases", xtitle = "Days from 100 Cases")
plotNE <- plotThis(BrCases, NE, ytitle = "Confirmed Cases", xtitle = "Days from 100 Cases")
plotS_SE <- plotThis(BrCases, S_SE, ytitle = "Confirmed Cases", xtitle = "Days from 100 Cases")
plotCO <- plotThis(BrCases, CO, ytitle = "Confirmed Cases", xtitle = "Days from 100 Cases")


plot <- plotThis(BrCases, states, ytitle = "Confirmed Cases", xtitle = "Days from 100 Cases")

# fig <- subplot(plotN$plotly, plotNE$plotly,plotCO$plotly,plotS_SE$plotly, nrows = 2, shareX = TRUE, shareY = FALSE, titleX = T, titleY = T)
# fig

plot$plotly

ggsave(paste0(ggpath, "5BRCases.png"))

```

### <b style = "color: #4c1112" > Comparative after 10 cases per 100.000 hab </b>
```{r, fig.width = 10, fig.height = 6}
states <- c("SP"
           ,"RJ"
           ,"CE"
           ,"MG"
           ,"RS"
           ,"DF"
           ,"PR"
           ,"BA"
           ,"AM"
           ,"SC"
           ,"RN"
           ,"PE"
           ,"ES"
           ,"MA"
           ,"GO"
           ,"PA"
           ,"MS"
           ,"MT"
           ,"AC"
           ,"SE"
           ,"AL"
           ,"TO"
           ,"RO"
           ,"AP"
           ,"PB"
           ,"PI"
           ,"RR"
           )

plot <- plotThis10(BrCasesPop, states, ytitle = "Confirmed Cases", xtitle = "Days from 10 Cases")
plot$plotly
ggsave(paste0(ggpath, "BRCasespop.png"))

```

Row {data-width=350, data-height=350}
-----------------------------------------------------------------------

### Total Cases
```{r}
printDT(BrCasesFormatted,
        rownames(BrCasesFormatted)
        )
```

### New Cases
```{r}
printDT(dife_c_br,
        rownames(dife_c_br)
        )
```


### Var. (%)
```{r}
printDT(porce_c_br / 100,
        rownames(porce_c_br)
       ) %>% DT::formatPercentage(1:5, 2)
```


Cases per day Graphs {data-navmenu='Brasil'} 
==========================================================================

Column
-----------------------------------------------------------------------

### Cases per day
```{r, fig.width = 10, fig.height = 12}
dz <- 
BrCases %>% 
  t %>% 
  as_tibble %>% 
  mutate_all(~ . - lag(.)) %>% 
  mutate(Dates = as.Date(colnames(BrCases), format = "%m/%d/%y") ) %>% 
  select(Dates, everything()) %>% 
  mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .))

dw <- 
do.call(cbind, lapply(colnames(dz)[-1], function(x) TTR::SMA(dz[,x], 7))) %>% 
  as_tibble %>% 
  rename_all(~ paste0('M',colnames(dz)[-1])) %>% 
  mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) 

dh <- 
cbind(dz, dw) %>% 
  as_tibble %>% 
  filter(Dates >= as.Date("2020-03-20"))

f2 <- list(family = 'Old Standard TT, serif', size = 14, color = I("firebrick4"))

plots <- 
lapply(colnames(dh)[2:29], function(x){ 
                           expr   <- paste0("~", "`", x, "`")
                           mexpr  <- paste0("~", "`", "M", x, "`")
                           legm   <- paste0("Moving average of ", x)
                           a <- list(
                                      text = x,
                                      font = f2,
                                      xref = "paper",
                                      yref = "paper",
                                      yanchor = "bottom",
                                      xanchor = "center",
                                      align = "center",
                                      x = 0.5,
                                      y = 1,
                                      showarrow = FALSE
                                    )
                           plot_ly(dh, x = ~Dates) %>% 
                             add_trace(y = as.formula(expr),  type = 'bar', color = I("firebrick4")) %>% 
                             add_trace(y = as.formula(mexpr), type = 'scatter', mode = 'lines', color = I("black") ) %>% 
                             layout(showlegend = FALSE, annotations = a)
})
names(plots) <- colnames(dz)[-c(1, length(dz))]
p <- subplot(plots, nrows = 7, shareX = FALSE, shareY = FALSE)
p
```








Deaths {data-navmenu='Brasil'} 
==========================================================================

Column {.tabset}
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Comparative after 100 deaths </b>
```{r, fig.width = 10, fig.height = 6}
states <- c("SP"
           ,"RJ"
           ,"CE"
           ,"MG"
           ,"RS"
           ,"DF"
           ,"PR"
           ,"BA"
           ,"AM"
           ,"SC"
           ,"RN"
           ,"PE"
           ,"ES"
           ,"MA"
           ,"GO"
           ,"PA"
           ,"MS"
           ,"MT"
           ,"AC"
           ,"SE"
           ,"AL"
           ,"TO"
           ,"RO"
           ,"AP"
           ,"PB"
           ,"PI"
           ,"RR"
           )

plot <- plotThis(BrDeaths, states, ytitle = "Confirmed Deaths", xtitle = "Days from 100 Deaths")
plot$plotly
ggsave(paste0(ggpath, "6BRDeaths.png"))

```


<!-- Column  -->
<!-- ----------------------------------------------------------------------- -->
### <b style = "color: #4c1112" > Comparative after 10 deaths per 1.000.000 hab </b>
```{r, fig.width = 10, fig.height = 6}
states <- c("SP"
           ,"RJ"
           ,"CE"
           ,"MG"
           ,"RS"
           ,"DF"
           ,"PR"
           ,"BA"
           ,"AM"
           ,"SC"
           ,"RN"
           ,"PE"
           ,"ES"
           ,"MA"
           ,"GO"
           ,"PA"
           ,"MS"
           ,"MT"
           ,"AC"
           ,"SE"
           ,"AL"
           ,"TO"
           ,"RO"
           ,"AP"
           ,"PB"
           ,"PI"
           ,"RR"
           )

plot <- plotThis10(BrDeathsPop, states, ytitle = "Confirmed Deaths", xtitle = "Days from 10 Deaths")
plot$plotly
ggsave(paste0(ggpath, "BRDeathspop.png"))
```



Row {data-width=350, data-height=350}
-----------------------------------------------------------------------

### Total Deaths
```{r}
printDT(BrDeathsFormatted,
        rownames(BrDeathsFormatted)
       )
```


### New Deaths
```{r}
printDT(dife_d_br,
        rownames(dife_d_br)
      )
```


### Var. (%)
```{r}
printDT(porce_d_br / 100,
        rownames(porce_d_br)
       ) %>% DT::formatPercentage(1:5, 2)
```


Deaths per day Graphs {data-navmenu='Brasil'} 
==========================================================================

Column
-----------------------------------------------------------------------

### Deaths per day
```{r, fig.width = 10, fig.height = 12}
dz <- 
BrDeaths %>% 
  t %>% 
  as_tibble %>% 
  mutate_all(~ . - lag(.)) %>% 
  mutate(Dates = as.Date(colnames(BrDeaths), format = "%m/%d/%y") ) %>% 
  select(Dates, everything()) %>% 
  mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .))

dw <- 
do.call(cbind, lapply(colnames(dz)[-1], function(x) TTR::SMA(dz[,x], 7))) %>% 
  as_tibble %>% 
  rename_all(~ paste0('M',colnames(dz)[-1])) %>% 
  mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) 

dh <- 
cbind(dz, dw) %>% 
  as_tibble %>% 
  filter(Dates >= as.Date("2020-03-20"))

f2 <- list(family = 'Old Standard TT, serif', size = 14, color = I("firebrick4"))

plots <- 
lapply(colnames(dh)[2:29], function(x){ 
                           expr   <- paste0("~", "`", x, "`")
                           mexpr  <- paste0("~", "`", "M", x, "`")
                           legm   <- paste0("Moving average of ", x)
                           a <- list(
                                      text = x,
                                      font = f2,
                                      xref = "paper",
                                      yref = "paper",
                                      yanchor = "bottom",
                                      xanchor = "center",
                                      align = "center",
                                      x = 0.5,
                                      y = 1,
                                      showarrow = FALSE
                                    )
                           plot_ly(dh, x = ~Dates) %>% 
                             add_trace(y = as.formula(expr),  type = 'bar', color = I("firebrick4")) %>% 
                             add_trace(y = as.formula(mexpr), type = 'scatter', mode = 'lines', color = I("black") ) %>% 
                             layout(showlegend = FALSE, annotations = a)
})
names(plots) <- colnames(dz)[-c(1, length(dz))]
p <- subplot(plots, nrows = 7, shareX = FALSE, shareY = FALSE)
p
```





Tests {data-navmenu='Brasil'} 
==========================================================================

Column {.tabset}
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Tests </b>
```{r, fig.width = 10, fig.height = 6}
tg <- BrTests %>% 
        tibble::rownames_to_column() %>% 
        select(1, last_col()) %>% 
        rename_all(~ c("States", "Tests")) %>% 
        mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) 
tg <-tg[-c(28,29), ] 
tg <- arrange(tg,desc(Tests))


  
fig <- plot_ly(
  x = tg$States,
  y = tg$Tests,
  type = "bar",
  color = I("Gray")
) %>%
layout(
     title = "Total Tests",
     xaxis = list(title = "States",
     categoryorder = "array",
     categoryarray = ~tg$States),
     yaxis = list(title = "Tests")
)

fig

```

### <b style = "color: #4c1112" > Tests 100.000 hab </b>
```{r, fig.width = 10, fig.height = 6}
tg <- BrTestsP100k %>% 
        tibble::rownames_to_column() %>% 
        select(1, last_col()) %>% 
        rename_all(~ c("States", "Tests")) %>% 
        mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) 
tg <-tg[-c(28,29), ] 
tg <- arrange(tg,desc(Tests))


  
fig <- plot_ly(
  x = tg$States,
  y = tg$Tests,
  type = "bar",
  color = I("firebrick4")
) %>%
layout(
     title = "Total Tests per 100k hab.",
     xaxis = list(title = "States",
     categoryorder = "array",
     categoryarray = ~tg$States),
     yaxis = list(title = "Tests per 100k hab.")
)

fig

```

Row {data-width=350, data-height=350}
-----------------------------------------------------------------------

### Total Tests
```{r}
printDT(BrTestsFormatted,
        rownames(BrTestsFormatted)
        )
```

### New Tests
```{r}
printDT(dife_t_br,
        rownames(dife_t_br)
        )
```


### Tests per 100K hab. 
```{r}
printDT(BrTests100kFormatted,
        rownames(BrTests100kFormatted)
        )
```






Mortality {data-navmenu="Brasil"}
==========================================================================

Column {.tabset}
-----------------------------------------------------------------------

### <b style = "color: #4c1112"> Mortality Rate </b>
```{r, fig.height = 6, fig.width = 10}
BRstates <- c("SP", "RJ", "RS", "PE", "AM", "AP")

plotMortality(BrMortality, BRstates, "Brazil Mortality Rate by State")
```

### <b style = "color: #4c1112">  Daily variation of Mortality </b>
```{r, fig.height = 6, fig.width = 10}
dx <- 
BrMortality %>% 
  mutate_at(vars(-Dates), ~ . - lag(.)) %>% 
  mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) %>% 
  mutate_at(vars(-Dates), ~ round(., 2))

plotMortality(BrMortality, BRstates, "Brazil Mortality Rate Variation by State")
```

Comparative After 100 cases  {data-navmenu='Figures'}
====================================================================

Column {.tabset}
--------------------------------------------------------------------

### <b style = "color: #4c1112">  Cases relation with exponential growth </b>
```{r, fig.height = 6, fig.width = 10}
countries <- c("Italy", "Spain", "Brazil", "United States", "United Kingdom", "Germany","France")

plot <- plotThis(WorldCases, countries, ytitle = "Confirmed Cases", xtitle = "Days from 100 Cases")
p    <- plot$plotly

N <- 
WorldCases %>% 
  t() %>% 
  as_tibble() %>% 
  select(countries) %>% 
  summarise_all(~ sum(if_else(. > 100, 1, 0))) %>% 
  max

daysToDouble <- c(3,4,7)
Nd <- length(daysToDouble)
n  <- round(N/1.25)
exdf <- NULL
for (i in daysToDouble) {
     range     <- seq(ceiling(i*log(100, 2)), length.out = n)
     expVector <- vapply(range, function(d) 2**(d/i), numeric(1))
     exdf      <- cbind(exdf, expVector)
}
d0f <- as_tibble(exdf) %>% rename_all(~ paste0("V", 1:Nd)) %>% add_column(Days = 0:(n-1))

for (days in 1:Nd) {
  p <- p %>% add_lines(data = d0f, x = ~Days, y = as.formula(paste0('~V', days)), name = paste0('V', days), 
                       line = list(color = 'rgb(205, 12, 24)', dash = 'dot', width = 1),
                       showlegend = FALSE)
}

d10f <- log10(d0f)

A1 <- list(
  xref = 'paper',
  yref = 'y',
  x = log10(5),
  y = d10f[n,1] + 0.2,
  type = "log",
  xanchor = 'left',
  yanchor = 'middle',
  text = ~"Doubles every 3 days",
  font = list(family = 'Arial',
              size = 9.9,
              color = 'rgba(205,12,24,1)'),
  showarrow = FALSE)

A2 <- list(
  xref = 'paper',
  yref = 'y',
  x = log10(5),
  y = d10f[n,2] + 0.2,
  type = "log",
  xanchor = 'left',
  yanchor = 'middle',
  text = ~"Doubles every 4 days",
  font = list(family = 'Arial',
              size = 9.9,
              color = 'rgba(205,12,24,1)'),
  showarrow = FALSE)

A3 <- list(
  xref = 'paper',
  yref = 'y',
  x = log10(5),
  y = d10f[n,3] + 0.2,
  type = "log",
  xanchor = 'left',
  yanchor = 'middle',
  text = ~"Doubles every 7 days",
  font = list(family = 'Arial',
              size = 9.9,
              color = 'rgba(205,12,24,1)'),
  showarrow = FALSE)

p <- p %>% layout(annotations = A1)
p <- p %>% layout(annotations = A2)
p <- p %>% layout(annotations = A3)

p

ggfig <- 
plot$ggplot + 
  geom_line(d0f, mapping = aes(y = V1), linetype = 'dashed', color = "#CD0C0E") + 
  annotate('text', x = 55, y = d0f[n,1,drop=T] + 1.0e7, label = "Doubles every 3 days", color = "#CD0C0E") +
  geom_line(d0f, mapping = aes(y = V2), linetype = 'dashed', color = "#CD0C0E") +
  annotate('text', x = 55, y = d0f[n,2,drop=T] + 0.5e6, label = "Doubles every 4 days", color = "#CD0C0E") +
  geom_line(d0f, mapping = aes(y = V3), linetype = 'dashed', color = "#CD0C0E") +
  annotate('text', x = 55, y = d0f[n,3,drop=T] + 0.1e5, label = "Doubles every 7 days", color = "#CD0C0E") 
ggsave(paste0(ggpath,"7CasesExp.png"))
```

### <b style = "color: #4c1112">  Deaths relation with exponential growth </b>
```{r, fig.height = 6, fig.width = 10}

countries <- c("Italy", "Spain", "Brazil","United States", "United Kingdom", "Germany","France")

plot <- plotThis(WorldDeaths, countries, ytitle = "Confirmed Deaths", xtitle = "Days from 100 Deaths")
p    <- plot$plotly

N <- 
WorldDeaths %>% 
  t() %>% 
  as_tibble() %>% 
  select(countries) %>% 
  summarise_all(~ sum(if_else(. > 100, 1, 0))) %>% 
  max

daysToDouble <- c(3,4,7)
Nd <- length(daysToDouble)
n  <- round(N/1.45)
exdf <- NULL
for (i in daysToDouble) {
     range     <- seq(ceiling(i*log(100, 2)), length.out = n)
     expVector <- vapply(range, function(d) 2**(d/i), numeric(1))
     exdf      <- cbind(exdf, expVector)
}
d0f <- as_tibble(exdf) %>% rename_all(~ paste0("V", 1:Nd)) %>% add_column(Days = 0:(n-1))

for (days in 1:Nd) {
  p <- p %>% add_lines(data = d0f, x = ~Days, y = as.formula(paste0('~V', days)), name = paste0('V', days), 
                       line = list(color = 'rgb(205, 12, 24)', dash = 'dot', width = 1),
                       showlegend = FALSE)
}

d10f <- log10(d0f)

A1 <- list(
  xref = 'paper',
  yref = 'y',
  x = log10(4 - 0.1),
  y = d10f[n,1],
  type = "log",
  xanchor = 'left',
  yanchor = 'middle',
  text = ~"Doubles every 3 days",
  font = list(family = 'Arial',
              size = 9.9,
              color = 'rgba(205,12,24,1)'),
  showarrow = FALSE)

A2 <- list(
  xref = 'paper',
  yref = 'y',
  x = log10(4),
  y = d10f[n,2] + 0.2,
  type = "log",
  xanchor = 'left',
  yanchor = 'middle',
  text = ~"Doubles every 4 days",
  font = list(family = 'Arial',
              size = 9.9,
              color = 'rgba(205,12,24,1)'),
  showarrow = FALSE)

A3 <- list(
  xref = 'paper',
  yref = 'y',
  x = log10(4),
  y = d10f[n,3],
  type = "log",
  xanchor = 'left',
  yanchor = 'middle',
  text = ~"Doubles every 7 days",
  font = list(family = 'Arial',
              size = 9.9,
              color = 'rgba(205,12,24,1)'),
  showarrow = FALSE)

p <- p %>% layout(annotations = A1)
p <- p %>% layout(annotations = A2)
p <- p %>% layout(annotations = A3)

p

ggfig <- 
plot$ggplot + 
  geom_line(d0f, mapping = aes(y = V1), linetype = 'dashed', color = "#CD0C0E") + 
  annotate('text', x = 55, y = d0f[n,1,drop=T] + 1.0e7, label = "Doubles every 3 days", color = "#CD0C0E") +
  geom_line(d0f, mapping = aes(y = V2), linetype = 'dashed', color = "#CD0C0E") +
  annotate('text', x = 55, y = d0f[n,2,drop=T] + 0.5e6, label = "Doubles every 4 days", color = "#CD0C0E") +
  geom_line(d0f, mapping = aes(y = V3), linetype = 'dashed', color = "#CD0C0E") +
  annotate('text', x = 55, y = d0f[n,3,drop=T] + 0.1e5, label = "Doubles every 7 days", color = "#CD0C0E") 
ggsave(paste0(ggpath,"8DeathsExp.png"))
```

Doubling Time {data-navmenu='Figures'}
====================================================================

Column {.tabset}
-----------------------------------------------------------------------

### <b style = "color: #4c1112">  Time to double cases </b>
```{r, fig.height = 6, fig.width = 10}
countries <- c("United States"
              ,"Spain"
              ,"Italy"
              ,"Germany"
              ,"United Kingdom"
              ,"France"
              ,"Brazil"
              ,"Sweden"
              ,"Japan"
              )

doublingTime <- function(x) {
  y <- x - dplyr::lag(x) 
  x / y
}

da <- 
WorldCases %>% 
  t() %>% 
  as_tibble() %>% 
  select(all_of(countries)) %>% 
  mutate_all(~ TTR::SMA(., 7)) %>% 
  mutate_all(doublingTime) %>% 
  mutate(Days = as.Date(DatesWorld)) %>% 
  filter(Days >= as.Date("2020-03-02"))

gg <- ggplot(da, aes(x = Days)) 
for (i in countries) {
  gg <- gg + geom_line(aes_(y = as.name(i),  colour = i), na.rm = TRUE) +
             geom_point(aes_(y = as.name(i), colour = i), na.rm = TRUE)
}
gg <- gg + labs(x = "Days", y = "Doubling Time")
gg <- gg + theme(legend.position = 'bottom') +
           scale_color_manual("", values = plotlyColors, breaks = countries)

ggplotly(gg, height = 500, width = 1200) %>%
  layout(legend = list(orientation = 'h', x = +0.05, y = -0.15))
ggsave(paste0(ggpath, "DoublingTime.png"))
```

Total Cases After Lockdown {data-navmenu='Figures'}
====================================================================

Column {.tabset}
-----------------------------------------------------------------------

### <b style = "color: #4c1112">  Cases after lockdown </b>
```{r, fig.height = 6, fig.width = 10}
countries       <- c('France', 'Spain', 'Italy', 'United Kingdom', 'Austria', 'Denmark', 'Norway')
lockdown        <- c("2020-03-17", "2020-03-14", "2020-03-08", "2020-03-23", "2020-03-15", "2020-03-13", "2020-03-12")
names(lockdown) <- countries

lockdownPlot(dife_c, countries, lockdown, DatesWorld)
```

### <b style = "color: #4c1112">  Deaths after lockdown </b>
```{r, fig.height = 6, fig.width = 10}
lockdownPlot(dife_d, countries, lockdown, DatesWorld)
```

### <b style = "color: #4c1112">  Cases variation after lockdown </b>
```{r, fig.height = 6, fig.width = 10}
lockdownPlot(porce_c, countries, lockdown, DatesWorld)
```

### <b style = "color: #4c1112">  Deaths variation after lockdown </b>
```{r, fig.height = 6, fig.width = 10}
lockdownPlot(porce_d, countries, lockdown, DatesWorld)
```
