---
title: "Covid-19"
output: 
  flexdashboard::flex_dashboard:
    css: style.css
    orientation: rows
    vertical_layout: scroll
  rmarkdown:: github_document
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(xts)
library(plotly)

# hex msafra: #4c1211
# rgb msafra: 761817

plotlyColors <-   c('#1f77b4',  # muted blue
                    '#ff7f0e',  # safety orange
                    '#2ca02c',  # cooked asparagus green
                    '#d62728',  # brick red
                    '#9467bd',  # muted purple
                    '#8c564b',  # chestnut brown
                    '#e377c2',  # raspberry yogurt pink
                    '#7f7f7f',  # middle gray
                    '#bcbd22',  # curry yellow-green
                    '#17becf')  # blue-teal

chart.fl <- function(ts, title = '', colorset = plotlyColors) {
    require(dygraphs)
    dygraph(ts, main = title, group = 'master') %>% 
    dyOptions(colors = colorset, axisLineWidth = .5, gridLineColor = 'lightgray') %>%
    #dyRangeSelector(height = 10, strokeColor = '') %>%
    dyHighlight(highlightSeriesBackgroundAlpha = 0.8) %>%
    dyLegend(show = 'auto', width = 150, hideOnMouseOut = TRUE)
}

#========================================================================================================
# Setting time span: Watch out the time of updating
dias <- ceiling(difftime(Sys.Date(), "2020-01-22", units = "days")) #+ 1

#========================================================================================================
# Fetching Main databases -----------------------------------------------------
WorldRepoCases  <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"
WorldRepoDeaths <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv"
USRepo          <- "https://raw.githubusercontent.com/COVID19Tracking/covid-tracking-data/master/data/states_daily_4pm_et.csv"
BRRepo          <- "https://raw.githubusercontent.com/wcota/covid19br/master/cases-brazil-states.csv"

# World Cases
RawWorldCases <- readr::read_csv(WorldRepoCases, 
                              col_types = paste0('cc', strrep('d', dias + 2))
                             ) 

# World Deaths
RawWorldDeaths <- readr::read_csv(WorldRepoDeaths, 
                               col_types = paste0('cc', strrep('d', dias + 2))
                              ) 

# US
RawUs <- readr::read_csv(USRepo,
                      col_types = paste0('ic', strrep('i', 10), 'c', 'T', strrep('i', 11))
                     )
                     

# BR
RawBr <- readr::read_csv(BRRepo,
                      col_types = paste0('D', 'ccc', strrep('i', 6))
                     )

#========================================================================================================
# Formatting dataframes -----------------------------------------------------

# World
SelectedCountries <- c("Italy"
                      ,"Spain"
                      ,"Germany"
                      ,"France"
                      ,"United Kingdom"
                      ,"Switzerland"
                      ,"Belgium"
                      ,"Netherlands"
                      ,"Austria"
                      ,"Portugal"
                      ,"Sweden"
                      ,"Norway"
                      ,"Denmark"
                      ,"Ireland"
                      ,"Romania"
                      ,"Luxembourg"
                      ,"Finland"
                      ,"Greece"
                      ,"Poland"
                      ,"Kosovo")

WorldCases <- RawWorldCases %>% 
  select(-`Province/State`, -Lat, -Long) %>% 
  group_by(`Country/Region`) %>% 
  summarise_all(sum) %>% 
  tibble::column_to_rownames(var = "Country/Region")

# Need to fix some countings to be able to make a map plot (Somewhat Ugly Code. Think about this!) ----

totalCongo <- WorldCases %>% 
                filter(rownames(WorldCases) == "Congo (Brazzaville)" | rownames(WorldCases) == "Congo (Kinshasa)") %>%  
                colSums

totalItaly <- WorldCases %>% 
                filter(rownames(WorldCases) == "Italy" | rownames(WorldCases) == "Holy See") %>% 
                colSums

totalEgypt <- WorldCases %>% 
                filter(rownames(WorldCases) == "Egypt" | rownames(WorldCases) == "Western Sahara") %>% 
                colSums

condition   <- !rownames(WorldCases) %in% c("Italy", "Holy See", "Egypt", "Western Sahara", "Congo (Brazzaville)", "Congo (Kinshasa)")
NewRowNames <-  c(rownames(WorldCases)[condition], "Congo", "Italy", "Egypt")

WC   <- c("Bahamas", "Czechia", "Eswatini", "Gambia", "North Macedonia", "Taiwan*", "US", "West Bank and Gaza", "Congo")
out  <- c("Bahamas", "Czechia", "Swaziland", "Gambia", "Macedonia", "Taiwan", "United States", "West Bank", "Congo")

NewRowNames[NewRowNames %in% WC] <- out

WorldCases <- WorldCases %>%  
                filter(condition) %>% 
                rbind(totalCongo) %>% 
                rbind(totalItaly) %>% 
                rbind(totalEgypt)
rownames(WorldCases) <- NewRowNames

WorldDeaths <- RawWorldDeaths %>% 
  select(-`Province/State`,-Lat,-Long) %>% 
  group_by(`Country/Region`) %>% 
  summarise_all(sum) %>% 
  tibble::column_to_rownames(var = "Country/Region") 

# Need to fix some countings to be able to make a map plot (Somewhat Ugly Code. Think about this!) ----

totalCongo <- WorldDeaths %>% 
                filter(rownames(WorldDeaths) == "Congo (Brazzaville)" | rownames(WorldDeaths) == "Congo (Kinshasa)") %>%  
                colSums

totalItaly <- WorldDeaths %>% 
                filter(rownames(WorldDeaths) == "Italy" | rownames(WorldDeaths) == "Holy See") %>% 
                colSums

totalEgypt <- WorldDeaths %>% 
                filter(rownames(WorldDeaths) == "Egypt" | rownames(WorldDeaths) == "Western Sahara") %>% 
                colSums

WorldDeaths <- WorldDeaths %>%  
                filter(condition) %>% 
                rbind(totalCongo) %>% 
                rbind(totalItaly) %>% 
                rbind(totalEgypt) 
rownames(WorldDeaths) <- NewRowNames

#========================================================================================================
# Brasil

demaisEstados <- c("AC","SE","AL","TO")

SelectedBR    <- c("Brasil"
                  ,"SP"
                  ,"RJ"
                  ,"CE"
                  ,"MG"
                  ,"RS"
                  ,"DF"
                  ,"PR"
                  ,"BA"
                  ,"AM"
                  ,"SC"
                  ,"RN"
                  ,"PE"
                  ,"ES"
                  ,"MA"
                  ,"GO"
                  ,"PA"
                  ,"MS"
                  ,"MT"
                  ,"Demais")

BrCases <- RawBr %>% 
  select(date, state, totalCases) %>% 
  tidyr::spread(date, totalCases, fill = 0) %>% 
  tibble::column_to_rownames(var = "state") %>% 
  rename_all(function(x) format(as.Date(x), "%m/%d/%y"))

BrCases <- BrCases %>% rbind(
   filter(BrCases, rownames(BrCases) %in% demaisEstados) %>% colSums
  )
rownames(BrCases)[28:29] <- c("Brasil", "Demais")

BrDeaths <- RawBr %>% 
  select(date, state, deaths) %>% 
  tidyr::spread(date, deaths, fill = 0) %>% 
  tibble::column_to_rownames(var = "state") %>% 
  rename_all(function(x) format(as.Date(x), "%m/%d/%y"))

BrDeaths <- BrDeaths %>% rbind(
   filter(BrDeaths, rownames(BrDeaths) %in% demaisEstados) %>% colSums
  )
rownames(BrDeaths)[28:29] <- c("Brasil", "Demais")

#========================================================================================================
# USA

USstates   <- c("NY"
               ,"NJ"
               ,"MI"
               ,"CA"
               ,"MA"
               ,"FL"
               ,"IL"
               ,"LA"
               ,"WA"
               ,"PA"
               ,"GA"
               ,"TX"
               ,"CT"
               ,"CO"
               ,"TN"
               ,"OH"
               ,"IN"
               ,"MD")

SelectedUS <- c("US"
               ,"New York"
               ,"New Jersey"
               ,"Michigan"
               ,"California"
               ,"Massachusetts"
               ,"Florida"
               ,"Illinois"
               ,"Louisiana"
               ,"Washington"
               ,"Pennsylvania"
               ,"Georgia"
               ,"Texas"
               ,"Connecticut"
               ,"Colorado"
               ,"Tennessee"
               ,"Ohio"
               ,"Indiana"
               ,"Maryland"
               ,"Others")

UsCases <- RawUs %>% 
  select(positive, state, dateChecked) %>% 
  arrange(dateChecked) %>% 
  tidyr::spread(dateChecked, positive, fill = 0) %>% 
  rename_at(vars(-1), function(x) format(as.Date(x), "%m/%d/%y")) %>% 
  tibble::column_to_rownames("state")

UsCases <- UsCases %>% rbind(
    filter(UsCases, !(rownames(UsCases) %in% USstates)) %>% colSums
)

UsCases <- UsCases %>% rbind(
    filter(UsCases, rownames(UsCases) != 57) %>% colSums
)
rownames(UsCases)[57:58] <- c("Others", "US")

UsDeaths <- RawUs %>% 
  select(death, state, dateChecked) %>% 
  arrange(dateChecked) %>% 
  tidyr::spread(dateChecked, death, fill = 0) %>% 
  rename_at(vars(-1), function(x) format(as.Date(x), "%m/%d/%y")) %>% 
  tibble::column_to_rownames("state")

UsDeaths <- UsDeaths %>% rbind(
    filter(UsDeaths, !(rownames(UsDeaths) %in% USstates)) %>% colSums
)

UsDeaths <- UsDeaths %>% rbind(
    filter(UsDeaths, rownames(UsDeaths) != 57) %>% colSums
)
rownames(UsDeaths)[57:58] <- c("Others", "US")

#========================================================================================================
# Data in xts format -------------------------------------------------------

# World
xtsDates <- seq.Date(from       = as.Date('2020-01-22'),
                     length.out = dias,
                     by         = 'day')

cts <- xts(log10(t(WorldCases)  + 1), xtsDates)
dts <- xts(log10(t(WorldDeaths) + 1), xtsDates)

countriesAsia     <- c("China", "Japan", "Singapore", "Korea, South")
valuesAsia        <- round(10**(tail(cts[,countriesAsia], 1)) - 1, 0)
dvaluesAsia       <- round(10**(tail(dts[,countriesAsia], 1)) - 1, 0)

countriesEUR      <- c("Germany", "Italy", "France", "Spain")
valuesEUR         <- round(10**(tail(cts[,countriesEUR], 1)) - 1, 0)
dvaluesEUR        <- round(10**(tail(dts[,countriesEUR], 1)) - 1, 0)

countriesAmerica  <- c("Mexico", "Brazil", "United States")
valuesAmerica     <- round(10**(tail(cts[,countriesAmerica], 1)) - 1, 0)
dvaluesAmerica    <- round(10**(tail(dts[,countriesAmerica], 1)) - 1, 0)

# US
USDates <- seq.Date(from       = as.Date('2020-02-28'),
                    to         = Sys.Date() - 1,
                    by         = 'day')

UsCasesXts  <- xts(log10(t(UsCases)  + 1), USDates)
UsDeathsXts <- xts(log10(t(UsDeaths) + 1), USDates)

#========================================================================================================
# Useful functions ---------------------------------------------------------

difference <- function(x) {
  this <- x[,-1] - x[,-ncol(x)]
  return(this)
}

percentage <- function(x) {
    this <- (100 * difference(x) / x[,-ncol(x)]) %>% round(2)
    return(this)
}

printDT <- function(x, selectedRows) {
    toPrint <- x[selectedRows,] %>% select(last_col(0:4)) 
    this <- DT::datatable(toPrint, 
                          options = list(pageLength = 20, 
                                         paging     = FALSE,
                                         searching  = FALSE,
                                         autoWidth  = TRUE,
                                         columnDefs = list(
                                           list(width = '100px', targets = 0:5, tablelayout = 'fixed')
                                         ),
                                          initComplete = DT::JS(
                                              "function(settings, json) {",
                                              "$(this.api().table().header()).css({'background-color': '#4c1112', 'color': '#fff'});",
                                              "}")
                                         ),
                          class = 'compact cell-border'
                          ) %>%  DT::formatStyle(columns = 0:5, fontSize = '14pt', color = "#4c1112")
    return(this)
}

#========================================================================================================
# Generating table data ---------------------------------------------------------

# World Cases
dife_c  <- difference(WorldCases)
porce_c <- percentage(WorldCases)

# World Deaths
dife_d  <- difference(WorldDeaths)
porce_d <- percentage(WorldDeaths)

# World Mortality
WorldMortality <- (WorldDeaths / WorldCases) %>%
                    mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) %>%
                    t() %>% 
                    as.xts(xtsDates)

colnames(WorldMortality) <- rownames(WorldCases)

# Us Cases
UsCasesFormatted <- UsCases[c("US", USstates, "Others"), ] %>% select(last_col(4:0)) 
rownames(UsCasesFormatted) <- SelectedUS

dife_c_us <- difference(UsCases)[c("US", USstates, "Others"), ] %>% select(last_col(4:0))
rownames(dife_c_us) <- SelectedUS

porce_c_us <- percentage(UsCases)[c("US", USstates, "Others"), ] %>% select(last_col(4:0))
rownames(porce_c_us) <- SelectedUS

# Us Deaths
UsDeathsFormatted <- UsDeaths[c("US", USstates, "Others"), ] %>% select(last_col(4:0)) 
rownames(UsDeathsFormatted) <- SelectedUS

dife_d_us <- difference(UsDeaths)[c("US", USstates, "Others"), ] %>% select(last_col(4:0))
rownames(dife_c_us) <- SelectedUS

porce_d_us <- percentage(UsDeaths)[c("US", USstates, "Others"), ] %>% select(last_col(4:0))
rownames(porce_c_us) <- SelectedUS

# US Mortality
UsMortality <- (UsDeaths / UsCases) %>% 
                 mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) %>%
                 t() %>% 
                 as.xts(USDates)

colnames(UsMortality) <- rownames(UsCases)

# Brazil Cases
BrCasesFormatted <- BrCases[SelectedBR, ] %>% select(last_col(4:0))
dife_c_br        <- difference(BrCases)[SelectedBR, ] %>% select(last_col(4:0))
porce_c_br       <- percentage(BrCases)[SelectedBR, ] %>% select(last_col(4:0))

# Brazil Deaths
BrDeathsFormatted <- BrDeaths[SelectedBR, ] %>% select(last_col(4:0))
dife_d_br         <- difference(BrDeaths)[SelectedBR, ] %>% select(last_col(4:0))
porce_d_br        <- percentage(BrDeaths)[SelectedBR, ] %>% select(last_col(4:0))

# Brazil Mortality
BRDates <- seq.Date(from = as.Date('2020-02-25'),
                    to   = Sys.Date() - 1,
                    by   = 'day')

BrMortality <- (BrDeaths / BrCases) %>% 
                 mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) %>% 
                 t() %>% 
                 as.xts(BRDates)

colnames(BrMortality) <- rownames(BrCases)

#========================================================================================================
# Reading country codes for map plot. -------------------------------------------------------------------
WorldCodes <- readr::read_csv(file = "../worldCodes.csv"
                             ,col_names = TRUE
                             ,col_types = 'cc')

USACodes <- readr::read_csv(file = "../usaCodes.csv"
                           ,col_names = TRUE
                           ,col_types = 'cc')
```


Overview {data-navmenu='World'}
======================================================================

Row {data-width = 800, data-height = 100}
-----------------------------------------

### World Cases {.no-title}
```{r, fig.width = 10, fig.height = 7}
# MAGIC TIME! Joinining dataframes by country and filling the NA with 0
dg <- WorldCases %>% 
        tibble::rownames_to_column() %>% 
        select(1, last_col()) %>% 
        rename_all(~ c("COUNTRY", "CASES")) %>% 
        left_join(WorldCodes, ., by = 'COUNTRY') %>% 
        mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) 

# light grey boundaries
l <- list(color = toRGB("grey"), width = 0.5)

# specify map projection/options
g <- list(
  showframe      = FALSE,
  showcoastlines = TRUE,
  projection = list(type = 'Equirectangular')
)

fig <- plot_geo(dg, width = 1200, height = 800)
fig <- fig %>% add_trace(
    customdata = ~CASES,
    z = ~log10(CASES + 1), 
    colorscale = "Greys",
    reversescale = TRUE,
    showscale = FALSE,
    hovertemplate = paste("Cases: %{customdata} <extra>%{text}</extra>"),
    text = ~COUNTRY, locations = ~CODE, marker = list(line = l)
  )
fig <- fig %>% colorbar(title = 'CASES')
fig <- fig %>% layout(
    title = '<b>Worldwide COVID-19 Total Cases.</b>',
    geo = g,
    autosize = FALSE
)

fig
```

Row {data-width=350, data-height=350}
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Total Deaths </b>
```{r}
toPrint <- WorldDeaths %>% select(last_col(0:4))
DT::datatable(toPrint,
              options = list(order = list(list(1, 'desc')),
                             initComplete = DT::JS(
                                 "function(settings, json) {", 
                                 "$(this.api().table().header()).css({'background-color': '#4c1112', 'color': '#fff'});",
                                 "}")
                             
                             ),
              class = 'compact cell-border',
) %>%  DT::formatStyle(columns = 0:ncol(toPrint), fontSize = '14pt', color = "#4c1112")

```

### <b style = "color: #4c1112" > Total Cases </b>
```{r}
toPrint <- WorldCases %>% select(last_col(0:4))
DT::datatable(toPrint, 
              options = list(order = list(list(5, 'desc')),
                             initComplete = DT::JS(
                                 "function(settings, json) {", 
                                 "$(this.api().table().header()).css({'background-color': '#4c1112', 'color': '#fff'});",
                                 "}")
                            
                            ),
              class = 'compact cell-border',
) %>%  DT::formatStyle(columns = 0:ncol(toPrint), fontSize = '14pt', color = "#4c1121")
              class = 'compact cell-border'
```

Mortality {data-navmenu='World'}
==========================================================================

Column {.tabset}
-----------------------------------------------------------------------

### <b style = "color: #4c1112"> Mortality Rate </b>
```{r, fig.height = 6, fig.width = 10}
xax <-  list(
              title = "Date",
              rangeselector = list(
                buttons = list(
                  list(
                    count = 7,
                    label = "1 week",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 14,
                    label = "2 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 21,
                    label = "3 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 30,
                    label = "4 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    step = "all") )),
        
              rangeslider = list(type = "date",
                                 thickness = 0.03)
             ) 

WorldCountries <- c("United States"
                   ,"Italy"
                   ,"Spain"
                   ,"France"
                   ,"United Kingdom"
                   #,"Iran"
                   ,"China"
                   ,"Germany"
                   ,"Netherlands"
                   ,"Brazil")

y = coredata(WorldMortality) %>% round(2)
x = index(WorldMortality)

fig <- plot_ly(x = ~x)
for (country in WorldCountries) {
  fig <- fig %>% add_trace(y = y[,country], name = country, type = 'scatter', mode = 'lines+markers')
}
fig <- fig %>% layout(
  title = "Mortality Rate by Country",
  xaxis = xax,
  yaxis = list(title = "Mortality", tickformat = "%")
)


fig
```

### <b style = "color: #4c1112">  Daily variation of Mortality </b>
```{r, fig.height = 6, fig.width = 10}
xax <-  list(
              title = "Date",
              rangeselector = list(
                buttons = list(
                  list(
                    count = 7,
                    label = "1 week",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 14,
                    label = "2 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 21,
                    label = "3 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 30,
                    label = "4 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    step = "all") )),
        
              rangeslider = list(type = "date",
                                 thickness = 0.03)
             ) 

dx = na.omit(diff(WorldMortality))      
y = coredata(dx) %>% round(2)
x = index(dx)

fig <- plot_ly(x = ~x)
for (country in WorldCountries) {
  fig <- fig %>% add_trace(y =  y[,country], name = country, type = 'scatter', mode = 'lines+markers')
}
fig <- fig %>% layout(
  title = "Mortality Rate Variation by Country",
  xaxis = xax,
  yaxis = list(title = "Mortality change", tickformat = "%")
)

fig
```

Cases {data-navmenu='Europe'} 
==========================================================================

Column 
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Comparative after 100 cases </b>
```{r, fig.width = 10, fig.height = 6}
countries <- c("Italy", "Spain", "France", "Germany", "United Kingdom", "Netherlands")

f1 <- list(family = 'Old Standard TT, serif', size = 14, color = 'black')

ects <- 10**(cts) - 1
d0ts <- ects * apply(ects, 2, function(x) x >= 100)
ld0ts <- lapply(countries, function(n) as.vector(coredata(d0ts[,n])))
ld0ts <- lapply(ld0ts, function(x) x[x!=0])
names(ld0ts) <- countries

N = max(vapply(ld0ts, length, numeric(1)))

d0f <- rbind(as.data.frame(lapply(ld0ts, '[', 1)), as.data.frame(lapply(ld0ts, '[', 2)))
for (i in 3:N) {
   d0f <- rbind(d0f, as.data.frame(lapply(ld0ts, '[', i)))
}

d0f <- cbind(0:(N - 1), d0f)
colnames(d0f) <- c('Days', countries)

p <- plot_ly(d0f, x = ~Days, height = 550)
for (country in countries) {
    countryExpr <- paste0("~","`", country, "`")
    p <- p %>% add_trace(data = d0f, y = as.formula(countryExpr), name = country, type = 'scatter', mode = 'lines+markers')
}

xax <- list(
  title = 'Days from 100 cases',
  titlefont = f1,
  showticklabels = TRUE,
 # range = c(0.5, 45),
  size = 13
)

yax <- list(
  title = 'Confirmed cases',
  titlefont = f1,
  showticklabels = TRUE,
  type = "log",
  size = 50
)

leg <- list(
  orientation = 'h',
  y = -0.15,
  x = -0.05
  )
p <- p %>% layout(xaxis = xax, yaxis = yax, legend = leg)

p
```

### <b style = "color: #4c1112" > Europe: Total Cases </b>
```{r, fig.width = 10, fig.height = 6, fig.align = 'right'}
## MAGIC TIME! Joinining dataframes by country and filling the NA with 0
dg <- WorldCases %>% 
        tibble::rownames_to_column() %>% 
        select(1, last_col()) %>% 
        rename_all(~ c("COUNTRY", "CASES")) %>% 
        left_join(WorldCodes, ., by = 'COUNTRY') %>% 
        mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) 

# light grey boundaries
l <- list(color = toRGB("grey"), width = 0.5)

# specify map projection/options
g <- list(
  scope = 'europe',
  showframe = FALSE,
  showcoastlines = TRUE,
  projection = list(type = 'Equirectangular')
)

fig <- plot_geo(dg) #, width = 800, height = 650)
fig <- fig %>% add_trace(
    customdata = ~CASES,
    z = ~log10(CASES + 1), 
    colorscale    = "Greys",
    reversescale  = TRUE,
    showscale     = FALSE,
    hovertemplate = paste("Cases: %{customdata} <extra>%{text}</extra>"),
    text = ~COUNTRY, locations = ~CODE, marker = list(line = l)
  )
fig <- fig %>% layout(
    title = '<b>Europe COVID-19 Cases.</b>',
    geo = g,
    autosize = TRUE
)

fig
```

Column {data-width=350}
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Total Cases </b>
```{r}
printDT(WorldCases, 
        SelectedCountries
       )
```


### <b style = "color: #4c1112" > New Cases </b>
```{r}
printDT(dife_c, 
        SelectedCountries
       ) 
```

### <b style = "color: #4c1112" > Var (%) </b>
```{r}
printDT(porce_c / 100, 
        SelectedCountries
      ) %>% DT::formatPercentage(1:5, 2)
```




Deaths {data-navmenu='Europe'} 
==========================================================================

Column 
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Comparative After 100 cases </b>
```{r, fig.width = 10, fig.height = 6}
countries <- c("Italy", "Spain", "France", "Germany", "United Kingdom", "Netherlands")

f1 <- list(family = 'Old Standard TT, serif', size = 14, color = 'black')

ects <- 10**(dts) - 1
d0ts <- ects * apply(ects, 2, function(x) x >= 100)
ld0ts <- lapply(countries, function(n) as.vector(coredata(d0ts[,n])))
ld0ts <- lapply(ld0ts, function(x) x[x!=0])
names(ld0ts) <- countries

N = max(vapply(ld0ts, length, numeric(1)))

d0f <- rbind(as.data.frame(lapply(ld0ts, '[', 1)), as.data.frame(lapply(ld0ts, '[', 2)))
for (i in 3:N) {
   d0f <- rbind(d0f, as.data.frame(lapply(ld0ts, '[', i)))
}

d0f <- cbind(0:(N - 1), d0f)
colnames(d0f) <- c('Days', countries)

p <- plot_ly(d0f, x = ~Days, height = 550)
for (country in countries) {
    countryExpr <- paste0("~","`", country, "`")
    p <- p %>% add_trace(data = d0f, y = as.formula(countryExpr), name = country, type = 'scatter', mode = 'lines+markers')
}

xax <- list(
  title = 'Days from 100 deaths',
  titlefont = f1,
  showticklabels = TRUE,
 # range = c(0.5, 45),
  size = 13
)

yax <- list(
  title = 'Deaths',
  titlefont = f1,
  showticklabels = TRUE,
  type = "log",
  size = 50
)

leg <- list(
  orientation = 'h',
  y = -0.15,
  x = -0.05
  )
p <- p %>% layout(xaxis = xax, yaxis = yax, legend = leg)

p
```

### <b style = "color: #4c1112">  Europe: total deaths </b>
```{r, fig.width = 10, fig.height = 6, fig.align = 'right'}
## MAGIC TIME! Joinining dataframes by country and filling the NA with 0
dg <- WorldDeaths %>% 
        tibble::rownames_to_column() %>% 
        select(1, last_col()) %>% 
        rename_all(~ c("COUNTRY", "CASES")) %>% 
        left_join(WorldCodes, ., by = 'COUNTRY') %>% 
        mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) 

# light grey boundaries
l <- list(color = toRGB("grey"), width = 0.5)

# specify map projection/options
g <- list(
  scope = 'europe',
  showframe = FALSE,
  showcoastlines = TRUE,
  projection = list(type = 'Equirectangular')
)

fig <- plot_geo(dg) #, width = 800, height = 650)
fig <- fig %>% add_trace(
    customdata = ~CASES,
    z = ~log10(CASES + 1), 
    colorscale    = "Greys",
    reversescale  = TRUE,
    showscale     = FALSE,
    hovertemplate = paste("Cases: %{customdata} <extra>%{text}</extra>"),
    text = ~COUNTRY, locations = ~CODE, marker = list(line = l)
  )
fig <- fig %>% layout(
    title = '<b>Europe COVID-19 Deaths.</b>',
    geo = g,
    autosize = TRUE
)

fig
```

Column {data-width=350}
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Total Deaths </b>
```{r}
printDT(WorldDeaths,
        SelectedCountries
       )
```


### <b style = "color: #4c1112" > New Deaths </b>
```{r}
printDT(dife_d, 
        SelectedCountries
       )
```


### <b style = "color: #4c1112" > Var (%) </b>
```{r}
printDT(porce_d / 100, 
        SelectedCountries
       ) %>% DT::formatPercentage(1:5, 2)
```




Mortality {data-navmenu='Europe'}
=========================================================================

Column {.tabset}
-----------------------------------------------------------------------

### <b style = "color: #4c1112"> Mortality Rate </b>
```{r, fig.height = 6, fig.width = 10}
xax <-  list(
              title = "Date",
              rangeselector = list(
                buttons = list(
                  list(
                    count = 7,
                    label = "1 week",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 14,
                    label = "2 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 21,
                    label = "3 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 30,
                    label = "4 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    step = "all") )),
        
              rangeslider = list(type = "date",
                                 thickness = 0.03)
             ) 
      
y = coredata(WorldMortality) %>% round(2)
x = index(WorldMortality)

fig <- plot_ly(x = ~x)
for (country in countries) {
  fig <- fig %>% add_trace(y =  y[,country], name = country, type = 'scatter', mode = 'lines+markers')
}
fig <- fig %>% layout(
  title = "Europe Mortality Rate by State",
  xaxis = xax,
  yaxis = list(title = "Mortality", tickformat = "%")
)

fig
```

### <b style = "color: #4c1112">  Daily variation of Mortality </b>
```{r, fig.height = 6, fig.width = 10}
xax <-  list(
              title = "Date",
              rangeselector = list(
                buttons = list(
                  list(
                    count = 7,
                    label = "1 week",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 14,
                    label = "2 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 21,
                    label = "3 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 30,
                    label = "4 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    step = "all") )),
        
              rangeslider = list(type = "date",
                                 thickness = 0.03)
             ) 

dx = na.omit(diff(WorldMortality))      
y = coredata(dx) %>% round(2)
x = index(dx)

fig <- plot_ly(x = ~x)
for (country in countries) {
  fig <- fig %>% add_trace(y =  y[,country], name = country, type = 'scatter', mode = 'lines+markers')
}
fig <- fig %>% layout(
  title = "Europe Mortality Rate by State",
  xaxis = xax,
  yaxis = list(title = "Mortality change", tickformat = "%")
)

fig
```


Cases {data-navmenu='US'} 
==========================================================================

Column 
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Comparative After 100 cases </b>
```{r, fig.width = 10, fig.height = 6}
states <- c("New York", "New Jersey", "Michigan", "California", "Massachussets", "Florida", "Washington", "Texas")
abr    <- c("NY", "NJ", "MI", "CA", "MA", "FL", "WA", "TX")
  
f1 <- list(family = 'Old Standard TT, serif', size = 14, color = 'black')

ects  <- 10**(UsCasesXts) - 1
d0ts  <- ects * apply(ects, 2, function(x) x >= 100)
ld0ts <- lapply(abr, function(n) as.vector(coredata(d0ts[,n])))
ld0ts <- lapply(ld0ts, function(x) x[x!=0])
names(ld0ts) <- states

N = max(vapply(ld0ts, length, numeric(1)))

d0f <- rbind(as.data.frame(lapply(ld0ts, '[', 1)), as.data.frame(lapply(ld0ts, '[', 2)))
for (i in 3:N) {
   d0f <- rbind(d0f, as.data.frame(lapply(ld0ts, '[', i)))
}

d0f <- cbind(0:(N - 1), d0f)
colnames(d0f) <- c('Days', states)

p <- plot_ly(d0f, x = ~Days, height = 550)
for (country in states) {
    countryExpr <- paste0("~","`", country, "`")
    p <- p %>% add_trace(data = d0f, y = as.formula(countryExpr), name = country, type = 'scatter', mode = 'lines+markers')
}

xax <- list(
  title = 'Days from 100 cases',
  titlefont = f1,
  showticklabels = TRUE,
 # range = c(0.5, 45),
  size = 13
)

yax <- list(
  title = 'Confirmed cases',
  titlefont = f1,
  showticklabels = TRUE,
  type = "log",
  size = 50
)

leg <- list(
  orientation = 'h',
  y = -0.15,
  x = +0.05
  )
p <- p %>% layout(xaxis = xax, yaxis = yax, legend = leg)

p
```

### <b style = "color: #4c1112">  USA: total cases </b>
```{r, fig.width = 10, fig.height = 6, fig.align = 'right'}
## MAGIC TIME! Joinining dataframes by country and filling the NA with 0
dg <- UsCases %>% 
        tibble::rownames_to_column() %>% 
        select(1, last_col()) %>% 
        rename_all(~ c("code", "CASES")) %>% 
        left_join(USACodes, ., by = 'code') %>% 
        mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) 

# light grey boundaries
l <- list(color = toRGB("grey"), width = 0.5)

# specify map projection/options
g <- list(
  scope = 'usa',
  showframe = FALSE,
  showcoastlines = TRUE,
  projection = list(type = 'albers usa')
)

fig <- plot_geo(dg, locationmode = 'USA-states') #, width = 800, height = 650)
fig <- fig %>% add_trace(
    customdata = ~CASES,
    z = ~log10(CASES + 1), 
    colorscale    = "Greys",
    reversescale  = TRUE,
    showscale     = FALSE,
    hovertemplate = paste("Cases: %{customdata} <extra>%{text}</extra>"),
    text = ~state, locations = ~code, marker = list(line = l)
  )
fig <- fig %>% layout(
    title = '<b>USA COVID-19 Cases.</b>',
    geo = g,
    autosize = TRUE
)

fig
```


Column {data-width=350}
-----------------------------------------------------------------------

### <b style = "color: #4c1112"> New Cases </b>
```{r}
printDT(dife_c_us,
        rownames(dife_c_us)
        )
```

### <b style = "color: #4c1112"> Var. (%) </b>
```{r}
printDT(porce_c_us / 100,
        rownames(porce_c_us)
        ) %>% DT::formatPercentage(1:5, 2)
```

Column {data-width=350}
-----------------------------------------------------------------------

### <b style = "color: #4c1112">  Total Cases </b>
```{r}
printDT(UsCasesFormatted, 
        rownames(UsCasesFormatted)
        )
```


Deaths {data-navmenu='US'} 
==========================================================================

Column 
-----------------------------------------------------------------------

### <b style = "color: #4c1112" > Comparative After 100 cases </b>
```{r, fig.width = 10, fig.height = 6}

states <- c("New York", "New Jersey", "Michigan", "California", "Massachussets", "Florida", "Washington", "Texas")
abr    <- c("NY", "NJ", "MI", "CA", "MA", "FL", "WA", "TX")
  
f1 <- list(family = 'Old Standard TT, serif', size = 14, color = 'black')

ects  <- 10**(UsCasesXts) - 1
d0ts  <- ects * apply(ects, 2, function(x) x >= 100)
ld0ts <- lapply(abr, function(n) as.vector(coredata(d0ts[,n])))
ld0ts <- lapply(ld0ts, function(x) x[x!=0])
names(ld0ts) <- states

N = max(vapply(ld0ts, length, numeric(1)))

d0f <- rbind(as.data.frame(lapply(ld0ts, '[', 1)), as.data.frame(lapply(ld0ts, '[', 2)))
for (i in 3:N) {
   d0f <- rbind(d0f, as.data.frame(lapply(ld0ts, '[', i)))
}

d0f <- cbind(0:(N - 1), d0f)
colnames(d0f) <- c('Days', states)

p <- plot_ly(d0f, x = ~Days, height = 550)
for (country in states) {
    countryExpr <- paste0("~","`", country, "`")
    p <- p %>% add_trace(data = d0f, y = as.formula(countryExpr), name = country, type = 'scatter', mode = 'lines+markers')
}

xax <- list(
  title = 'Days from 100 deaths',
  titlefont = f1,
  showticklabels = TRUE,
 # range = c(0.5, 45),
  size = 13
)

yax <- list(
  title = 'Deaths',
  titlefont = f1,
  showticklabels = TRUE,
  type = "log",
  size = 50
)

leg <- list(
  orientation = 'h',
  y = -0.15,
  x = +0.05
  )
p <- p %>% layout(xaxis = xax, yaxis = yax, legend = leg)

p
```

### <b style = "color: #4c1112">  USA: total deaths </b>
```{r, fig.width = 10, fig.height = 6, fig.align = 'right'}
## MAGIC TIME! Joinining dataframes by country and filling the NA with 0
dg <- UsDeaths %>% 
        tibble::rownames_to_column() %>% 
        select(1, last_col()) %>% 
        rename_all(~ c("code", "CASES")) %>% 
        left_join(USACodes, ., by = 'code') %>% 
        mutate_if(~ any(is.na(.)), ~ if_else(is.na(.), 0, .)) 

# light grey boundaries
l <- list(color = toRGB("grey"), width = 0.5)

# specify map projection/options
g <- list(
  scope = 'usa',
  showframe = FALSE,
  showcoastlines = TRUE,
  projection = list(type = 'albers usa')
)

fig <- plot_geo(dg, locationmode = 'USA-states') #, width = 800, height = 650)
fig <- fig %>% add_trace(
    customdata = ~CASES,
    z = ~log10(CASES + 1), 
    colorscale    = "Greys",
    reversescale  = TRUE,
    showscale     = FALSE,
    hovertemplate = paste("Cases: %{customdata} <extra>%{text}</extra>"),
    text = ~state, locations = ~code, marker = list(line = l)
  )
fig <- fig %>% layout(
    title = '<b>USA COVID-19 Deaths.</b>',
    geo = g,
    autosize = TRUE
)

fig
```


Column {data-width=350}
-----------------------------------------------------------------------

### <b style = "color: #4c1112"> New Deaths </b>
```{r}
printDT(dife_d_us,
        rownames(dife_d_us)
        )
```

### <b style = "color: #4c1112"> Var. (%) </b>
```{r}
printDT(porce_d_us / 100,
        rownames(porce_d_us)
        ) %>% DT::formatPercentage(1:5, 2)
```

Column {data-width=350}
-----------------------------------------------------------------------

### <b style = "color: #4c1112">  Total Deaths </b>
```{r}
printDT(UsDeathsFormatted, 
        rownames(UsDeathsFormatted)
        )
```

Mortality {data-navmenu="US"}
==========================================================================

Column {.tabset}
-----------------------------------------------------------------------

### <b style = "color: #4c1112"> Mortality Rate </b>
```{r, fig.height = 6, fig.width = 10}
xax <-  list(
              title = "Date",
              rangeselector = list(
                buttons = list(
                  list(
                    count = 7,
                    label = "1 week",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 14,
                    label = "2 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 21,
                    label = "3 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 30,
                    label = "4 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    step = "all") )),
        
              rangeslider = list(type = "date",
                                 thickness = 0.03)
             ) 
      

y = coredata(UsMortality[,abr]) %>% round(2)
x = index(UsMortality)
colnames(y) <- states

fig <- plot_ly(x = ~x)
for (state in states) {
  fig <- fig %>% add_trace(y =  y[,state], name = state, type = 'scatter', mode = 'lines+markers')
}
fig <- fig %>% layout(
  title = "USA Mortality Rate by State",
  xaxis = xax,
  yaxis = list(title = "Mortality", tickformat = "%")
)

fig
```

### <b style = "color: #4c1112">  Daily variation of Mortality </b>
```{r, fig.height = 6, fig.width = 10}
xax <-  list(
              title = "Date",
              rangeselector = list(
                buttons = list(
                  list(
                    count = 7,
                    label = "1 week",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 14,
                    label = "2 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 21,
                    label = "3 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 30,
                    label = "4 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    step = "all") )),
        
              rangeslider = list(type = "date",
                                 thickness = 0.03)
             ) 

dx = na.omit(diff(UsMortality[,abr]))      
y = coredata(dx) %>% round(2)
x = index(dx)
colnames(y) <- states

fig <- plot_ly(x = ~x)
for (country in states) {
  fig <- fig %>% add_trace(y =  y[,country], name = country, type = 'scatter', mode = 'lines+markers')
}
fig <- fig %>% layout(
  title = "Mortality Rate Variation by State",
  xaxis = xax,
  yaxis = list(title = "Mortality change", tickformat = "%")
)

fig
```

Cases {data-navmenu='Brasil'} 
==========================================================================

Column {data-width=350}
-----------------------------------------------------------------------

### Total Cases
```{r}
printDT(BrCasesFormatted,
        rownames(BrCasesFormatted)
        )
```

Column {data-width=350}
-----------------------------------------------------------------------

### New Cases
```{r}
printDT(dife_c_br,
        rownames(dife_c_br)
        )
```

Column {data-width=350}
-----------------------------------------------------------------------

### Var. (%)
```{r}
printDT(porce_c_br / 100,
        rownames(porce_c_br)
       ) %>% DT::formatPercentage(1:5, 2)
```

Deaths {data-navmenu='Brasil'} 
==========================================================================

Column {data-width=350}
-----------------------------------------------------------------------

### Total Deaths
```{r}
printDT(BrDeathsFormatted,
        rownames(BrDeathsFormatted)
       )
```

Column {data-width=350}
-----------------------------------------------------------------------

### New Deaths
```{r}
printDT(dife_d_br,
        rownames(dife_d_br)
      )
```

Column {data-width=350}
-----------------------------------------------------------------------

### Var. (%)
```{r}
printDT(porce_d_br / 100,
        rownames(porce_d_br)
       ) %>% DT::formatPercentage(1:5, 2)
```

Mortality {data-navmenu="Brasil"}
==========================================================================

Column {.tabset}
-----------------------------------------------------------------------

### <b style = "color: #4c1112"> Mortality Rate </b>
```{r, fig.height = 6, fig.width = 10}
xax <-  list(
              title = "Date",
              rangeselector = list(
                buttons = list(
                  list(
                    count = 7,
                    label = "1 week",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 14,
                    label = "2 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 21,
                    label = "3 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 30,
                    label = "4 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    step = "all") )),
        
              rangeslider = list(type = "date",
                                 thickness = 0.03)
             ) 
      

BRstates <- c("SP", "RJ", "RS", "PE", "AM", "AP")

y = coredata(BrMortality) %>% round(2)
x = index(BrMortality)

fig <- plot_ly(x = ~x)
for (state in BRstates) {
  fig <- fig %>% add_trace(y =  y[,state], name = state, type = 'scatter', mode = 'lines+markers')
}
fig <- fig %>% layout(
  title = "Brazil Mortality Rate by State",
  xaxis = xax,
  yaxis = list(title = "Mortality", tickformat = "%")
)

fig
```

### <b style = "color: #4c1112">  Daily variation of Mortality </b>
```{r, fig.height = 6, fig.width = 10}
xax <-  list(
              title = "Date",
              rangeselector = list(
                buttons = list(
                  list(
                    count = 7,
                    label = "1 week",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 14,
                    label = "2 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 21,
                    label = "3 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    count = 30,
                    label = "4 weeks",
                    step  = "day",
                    stepmode = "backward"),
                  list(
                    step = "all") )),
        
              rangeslider = list(type = "date",
                                 thickness = 0.03)
             ) 

dx = na.omit(diff(BrMortality))      
y = coredata(dx) %>% round(2)
x = index(dx)

fig <- plot_ly(x = ~x)
for (country in BRstates) {
  fig <- fig %>% add_trace(y =  y[,country], name = country, type = 'scatter', mode = 'lines+markers')
}
fig <- fig %>% layout(
  title = "Mortality Rate Variation by State",
  xaxis = xax,
  yaxis = list(title = "Mortality change", tickformat = "%")
)

fig
```

<!-- Total Cases by Country Group {data-navmenu='Figures'}  -->
<!-- ====================================================================== -->

<!-- Column {data-width=300} -->
<!-- ----------------------------------------------------------------- -->

<!-- ### Asia Casos. `r vapply(countriesAsia, function(country) paste0(country, ": ", valuesAsia[,country]), character(1)) %>% as.vector()` -->
<!-- ```{r} -->
<!-- chart.fl(cts[,countriesAsia]) %>% dyRangeSelector(height = 10)  -->
<!-- ``` -->

<!-- ### Europe Casos. `r vapply(countriesEUR, function(country) paste0(country, ": ", valuesEUR[,country]), character(1)) %>% as.vector()` -->
<!-- ```{r} -->
<!-- chart.fl(cts[,countriesEUR]) %>% dyRangeSelector(height = 10)  -->
<!-- ``` -->

<!-- ### America Casos. `r vapply(countriesAmerica, function(country) paste0(country, ": ", valuesAmerica[,country]), character(1)) %>% as.vector()` -->
<!-- ```{r} -->
<!-- chart.fl(cts[,countriesAmerica]) %>% dyRangeSelector(height = 10)  -->
<!-- ``` -->

<!-- Column {data-width=300} -->
<!-- ----------------------------------------------------------------- -->

<!-- ### Asia Mortes. `r vapply(countriesAsia, function(country) paste0(country, ": ", dvaluesAsia[,country]), character(1)) %>% as.vector()` -->
<!-- ```{r} -->
<!-- chart.fl(dts[,countriesAsia]) %>% dyRangeSelector(height = 10)  -->
<!-- ``` -->

<!-- ### Europe Mortes. `r vapply(countriesEUR, function(country) paste0(country, ": ", dvaluesEUR[,country]), character(1)) %>% as.vector()` -->
<!-- ```{r} -->
<!-- chart.fl(dts[,countriesEUR]) %>% dyRangeSelector(height = 10)  -->
<!-- ``` -->

<!-- ### America Mortes. `r vapply(countriesAmerica, function(country) paste0(country, ": ", dvaluesAmerica[,country]), character(1)) %>% as.vector()` -->
<!-- ```{r} -->
<!-- chart.fl(dts[,countriesAmerica]) %>% dyRangeSelector(height = 10)  -->
<!-- ``` -->

Comparative After 100 cases  {data-navmenu='Figures'}
====================================================================

Column {.tabset}
--------------------------------------------------------------------

### <b style = "color: #4c1112">  Cases relation with exponential growth </b>
```{r, fig.height = 6, fig.width = 10}
countries <- c("Italy", "Spain", "Brazil","United States", "United Kingdom", "Germany","France")

ects <- 10**(cts) - 1
d0ts <- ects * apply(ects, 2, function(x) x >= 100)
ld0ts <- lapply(countries, function(n) as.vector(coredata(d0ts[,n])))
ld0ts <- lapply(ld0ts, function(x) x[x!=0])
names(ld0ts) <- countries

N = max(vapply(ld0ts, length, numeric(1)))

d0f <- rbind(as.data.frame(lapply(ld0ts, '[', 1)), as.data.frame(lapply(ld0ts, '[', 2)))
for (i in 3:N) {
   d0f <- rbind(d0f, as.data.frame(lapply(ld0ts, '[', i)))
}

daysToDouble <- c(3,4,7)
exdf <- NULL
for (i in daysToDouble) {
     exdf <- cbind(exdf, vapply(seq(ceiling(i*log(100, 2)), length.out = N), function(d) 2**(d/i), numeric(1)))
}

d0f <- cbind(d0f, exdf)
d0f <- d0f
d0f <- cbind(0:(N - 1), d0f)
DD  <- paste0("D", daysToDouble, "D")
colnames(d0f) <- c('Days', countries, DD)

#d0f <- 2^(d0f)

p <- plot_ly(d0f, x = ~Days)
for (country in countries) {
    countryExpr <- paste0("~", "`", country, "`")
    p <- p %>% add_trace(data = d0f, y = as.formula(countryExpr), name = country, type = 'scatter', mode = 'lines+markers')
}

for (days in DD) {
  p <- p %>% add_lines(data = d0f, y = as.formula(paste0('~', days)), name = days, 
                       line = list(color = 'rgb(205, 12, 24)', dash = 'dot', width = 1),
                       showlegend = FALSE)
}

xax <- list(
  title = 'Days from 100 cases',
  titlefont = f1,
  showticklabels = TRUE,
  range = c(0, 55),
  size = 13
)

yax <- list(
  title = 'Confirmed cases',
  titlefont = f1,
  showticklabels = TRUE,
  type = "log",
  range = c(1.98, 6),
  size = 50
)

leg <- list(
  orientation = 'h',
  y = -0.15,
  x = 0.25
  )

D2DA <- list(
  xref = 'paper',
  yref = 'y',
  x = 0.605,
  y = log10(d0f)[40, "D3D"],
  type = "log",
  xanchor = 'left',
  yanchor = 'middle',
  text = ~"Doubles every 3 days",
  font = list(family = 'Arial',
              size = 9.9,
              color = 'rgba(205,12,24,1)'),
  showarrow = FALSE)

D4DA <- list(
  xref = 'paper',
  yref = 'y',
  x = 0.915,
  y = tail(log10(d0f),1)[,'D4D'] + 0.12,
  type = "log",
  xanchor = 'left',
  yanchor = 'middle',
  text = ~"Doubles every 4 days",
  font = list(family = 'Arial',
              size = 9.9,
              color = 'rgba(205,12,24,1)'),
  showarrow = FALSE)

D7DA <- list(
  xref = 'paper',
  yref = 'y',
  x = 0.915,
  y = tail(log10(d0f),1)[,'D7D'] + 0.12,
  type = "log",
  xanchor = 'left',
  yanchor = 'middle',
  text = ~"Doubles every 7 days",
  font = list(family = 'Arial',
              size = 9.9,
              color = 'rgba(205,12,24,1)'),
  showarrow = FALSE)

p <- p %>% layout(xaxis = xax, yaxis = yax, legend = leg)
#p <- p %>% layout(annotations = D1DA)
p <- p %>% layout(annotations = D2DA)
p <- p %>% layout(annotations = D4DA)
p <- p %>% layout(annotations = D7DA)

p
```

### <b style = "color: #4c1112">  Deaths relation with exponential growth </b>
```{r, fig.height = 6, fig.width = 10}

countries <- c("Italy", "Spain", "Brazil","United States", "United Kingdom", "Germany","France")

ects <- 10**(dts) - 1
d0ts <- ects * apply(ects, 2, function(x) x >= 100)
ld0ts <- lapply(countries, function(n) as.vector(coredata(d0ts[,n])))
ld0ts <- lapply(ld0ts, function(x) x[x!=0])
names(ld0ts) <- countries

N = max(vapply(ld0ts, length, numeric(1)))

d0f <- rbind(as.data.frame(lapply(ld0ts, '[', 1)), as.data.frame(lapply(ld0ts, '[', 2)))
for (i in 3:N) {
   d0f <- rbind(d0f, as.data.frame(lapply(ld0ts, '[', i)))
}

daysToDouble <- c(3,4,7)
exdf <- NULL
for (i in daysToDouble) {
     exdf <- cbind(exdf, vapply(seq(ceiling(i*log(100, 2)), length.out = N), function(d) 2**(d/i), numeric(1)))
}

d0f <- cbind(d0f, exdf)
d0f <- d0f
d0f <- cbind(0:(N - 1), d0f)
DD  <- paste0("D", daysToDouble, "D")
colnames(d0f) <- c('Days', countries, DD)

p <- plot_ly(d0f, x = ~Days)
for (country in countries) {
    countryExpr <- paste0("~", "`", country, "`")
    p <- p %>% add_trace(data = d0f, y = as.formula(countryExpr), name = country, type = 'scatter', mode = 'lines+markers')
}

for (days in DD) {
  p <- p %>% add_lines(data = d0f, y = as.formula(paste0('~', days)), name = days, 
                       line = list(color = 'rgb(205, 12, 24)', dash = 'dot', width = 1),
                       showlegend = FALSE)
}

xax <- list(
  title = 'Days from 100 deaths',
  titlefont = f1,
  showticklabels = TRUE,
  range = c(0, 42),
  size = 13
)

yax <- list(
  title = 'Confirmed cases',
  titlefont = f1,
  showticklabels = TRUE,
  type = "log",
  range = c(1.98, 4.5),
  size = 50
)

leg <- list(
  orientation = 'h',
  y = -0.15,
  x = 0.25
  )

D2DA <- list(
  xref = 'paper',
  yref = 'y',
  x = 0.480,
  y = log10(d0f)[25,'D3D'],
  type = "log",
  xanchor = 'left',
  yanchor = 'middle',
  text = ~"Doubles every 3 days",
  font = list(family = 'Arial',
              size = 9.9,
              color = 'rgba(205,12,24,1)'),
  showarrow = FALSE)

D4DA <- list(
  xref = 'paper',
  yref = 'y',
  x = 0.750,
  y = log10(d0f)[30, "D4D"]  + 0.15,
  type = "log",
  xanchor = 'left',
  yanchor = 'middle',
  text = ~"Doubles every 4 days",
  font = list(family = 'Arial',
              size = 9.9,
              color = 'rgba(205,12,24,1)'),
  showarrow = FALSE)

D7DA <- list(
  xref = 'paper',
  yref = 'y',
  x = 0.920,
  y = tail(log10(d0f),1)[,'D7D'] + 0.12,
  type = "log",
  xanchor = 'left',
  yanchor = 'middle',
  text = ~"Doubles every 7 days",
  font = list(family = 'Arial',
              size = 9.9,
              color = 'rgba(205,12,24,1)'),
  showarrow = FALSE)

p <- p %>% layout(xaxis = xax, yaxis = yax, legend = leg)
p <- p %>% layout(annotations = D2DA)
p <- p %>% layout(annotations = D4DA)
p <- p %>% layout(annotations = D7DA)

p
```

Total Cases After Lockdown {data-navmenu='Figures'}
====================================================================

Column {.tabset}
-----------------------------------------------------------------------

### <b style = "color: #4c1112">  Cases after lockdown </b>
```{r, fig.height = 6, fig.width = 10}

countries <- c('France', 'Spain', 'Italy', 'United Kingdom', 'Austria', 'Denmark', 'Norway')
lockdown  <- c("2020-03-17", "2020-03-14", "2020-03-08", "2020-03-23", "2020-03-15", "2020-03-13", "2020-03-12")

names(lockdown) <- countries

dates <- colnames(dife_c) %>% as.Date(format = "%m/%d/%y")
ld    <- lapply(countries, function(x) as.vector(coredata(xts(t(dife_c), dates)[paste0(lockdown[x], '::'), x])))

LMAX = vapply(ld, length, numeric(1)) %>% max
df <- lapply(ld,  function(x) {
  c(x, rep(NA, LMAX - length(x)))
  } ) %>% do.call(cbind, .) %>% as.data.frame #%>% mutate_all(~replace(., is.na(.), 0)) 

df <- cbind(0:(LMAX - 1), df)
colnames(df) <- c("Days", countries)

p <- plot_ly(df, x = ~Days)
for (country in countries) {
    countryExpr <- paste0("~","`", country, "`")
    p <- p %>% add_trace(data = df, y = as.formula(countryExpr), name = country, type = 'scatter', mode = 'lines+markers')
}

xax <- list(
  title = 'Days from Lockdown',
  titlefont = f1,
  showticklabels = TRUE,
  range = c(0.5, 40),
  size = 13
)

yax <- list(
  title = 'New cases',
  titlefont = f1,
  showticklabels = TRUE,
 # type = "log",
  size = 50
)

leg <- list(
  orientation = 'h',
  y = -0.15,
  x =  0.25
  )
p <- p %>% layout(xaxis = xax, yaxis = yax, legend = leg)


p
```

### <b style = "color: #4c1112">  Deaths after lockdown </b>
```{r, fig.height = 6, fig.width = 10}
countries <- c('France', 'Spain', 'Italy', 'United Kingdom', 'Austria', 'Denmark', 'Norway')
lockdown  <- c("2020-03-17", "2020-03-14", "2020-03-08", "2020-03-23", "2020-03-15", "2020-03-13", "2020-03-12")

names(lockdown) <- countries

dates <- colnames(dife_d) %>% as.Date(format = "%m/%d/%y")
ld    <- lapply(countries, function(x) as.vector(coredata(xts(t(dife_d), dates)[paste0(lockdown[x], '::'), x])))

LMAX = vapply(ld, length, numeric(1)) %>% max
df <- lapply(ld,  function(x) {
  c(x, rep(NA, LMAX - length(x)))
  } ) %>% do.call(cbind, .) %>% as.data.frame #%>% mutate_all(~replace(., is.na(.), 0)) 

df <- cbind(1:LMAX, df)
colnames(df) <- c('Days', countries)

p <- plot_ly(df, x = ~Days)
for (country in countries) {
    countryExpr <- paste0("~","`", country, "`")
    p <- p %>% add_trace(data = df, y = as.formula(countryExpr), name = country, type = 'scatter', mode = 'lines+markers')
}

xax <- list(
  title = 'Days from Lockdown',
  titlefont = f1,
  showticklabels = TRUE,
  range = c(0.5, 40),
  size = 13
)

yax <- list(
  title = 'New deaths',
  titlefont = f1,
  showticklabels = TRUE,
 # type = "log",
  size = 50
)

leg <- list(
  orientation = 'h',
  y = -0.15,
  x =  0.25
  )

p <- p %>% layout(xaxis = xax, yaxis = yax, legend = leg)



p
```

### <b style = "color: #4c1112">  Cases variation after lockdown </b>
```{r, fig.height = 6, fig.width = 10}
countries <- c('France', 'Spain', 'Italy', 'United Kingdom', 'Austria', 'Denmark', 'Norway')
lockdown  <- c("2020-03-17", "2020-03-14", "2020-03-08", "2020-03-23", "2020-03-15", "2020-03-13", "2020-03-12")

names(lockdown) <- countries

dates <- colnames(porce_c) %>% as.Date(format = "%m/%d/%y")
ld    <- lapply(countries, function(x) as.vector(coredata(xts(t(porce_c / 100), dates)[paste0(lockdown[x], '::'), x])))

LMAX = vapply(ld, length, numeric(1)) %>% max
df <- lapply(ld,  function(x) {
  c(x, rep(NA, LMAX - length(x)))
  } ) %>% do.call(cbind, .) %>% as.data.frame #%>% mutate_all(~replace(., is.na(.), 0)) 

df <- cbind(1:LMAX, df)
colnames(df) <- c('Days', countries)

p <- plot_ly(df, x = ~Days)
for (country in countries) {
    countryExpr <- paste0("~","`", country, "`")
    p <- p %>% add_trace(data = df, y = as.formula(countryExpr), name = country, type = 'scatter', mode = 'lines+markers')
}

xax <- list(
  title = 'Days from Lockdown',
  titlefont = f1,
  showticklabels = TRUE,
  range = c(0.5, 40),
  size = 13
)

yax <- list(
  title = 'Rate of New cases',
  titlefont = f1,
  showticklabels = TRUE,
  tickformat = "%",
 # type = "log",
  size = 50
)

leg <- list(
  orientation = 'h',
  y = -0.15,
  x =  0.25
  )

p <- p %>% layout(xaxis = xax, yaxis = yax, legend = leg)



p
```

### <b style = "color: #4c1112">  Deaths variation after lockdown </b>
```{r, fig.height = 6, fig.width = 10}
countries <- c('France', 'Spain', 'Italy', 'United Kingdom', 'Austria', 'Denmark', 'Norway')
lockdown  <- c("2020-03-17", "2020-03-14", "2020-03-08", "2020-03-23", "2020-03-15", "2020-03-13", "2020-03-12")

names(lockdown) <- countries

dates <- colnames(porce_d) %>% as.Date(format = "%m/%d/%y")
ld    <- lapply(countries, function(x) as.vector(coredata(xts(t(porce_d / 100), dates)[paste0(lockdown[x], '::'), x])))

LMAX = vapply(ld, length, numeric(1)) %>% max
df <- lapply(ld,  function(x) {
  c(x, rep(NA, LMAX - length(x)))
  } ) %>% do.call(cbind, .) %>% as.data.frame #%>% mutate_all(~replace(., is.na(.), 0)) 

df <- cbind(1:LMAX, df)
colnames(df) <- c('Days', countries)

p <- plot_ly(df, x = ~Days)
for (country in countries) {
    countryExpr <- paste0("~","`", country, "`")
    p <- p %>% add_trace(data = df, y = as.formula(countryExpr), name = country, type = 'scatter', mode = 'lines+markers')
}

xax <- list(
  title = 'Days from Lockdown',
  titlefont = f1,
  showticklabels = TRUE,
  range = c(0.5, 40),
  size = 13
)

yax <- list(
  title = 'Rate of New deaths',
  titlefont = f1,
  showticklabels = TRUE,
  tickformat = "%",
 # type = "log",
  size = 50
)

leg <- list(
  orientation = 'h',
  y = -0.15,
  x =  0.25
  )

p <- p %>% layout(xaxis = xax, yaxis = yax, legend = leg)



p
```










